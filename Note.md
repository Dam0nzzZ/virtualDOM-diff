# 虚拟DOM、diff算法

**注意：**真实DOM如何变为虚拟DOM属于模板编译原理范畴mustache

diff是发生在虚拟DOM上的。新虚拟DOM和老虚拟DOM进行diff（精细化比较），计算出应该如何最小量更新，最后反映到真正DOM上



## 虚拟节点

### 虚拟节点的属性

```js
{
    children: undefined // 该节点子元素
    data: { props:{},style:{}}
    elm: undefined // 对应的真实DOM节点，为undefined则说明没上树，在 patch 函数执行后才会被赋值
    key: // 节点唯一标识
    sel: "div" // selector 选择器
    text: "I am a box" //
}
```

## h函数：生成虚拟节点vnode

- `h(tag, data, children)`
  - **标签名 (tag)**：一个字符串，表示要创建的 HTML 标签名，例如 `'div'`, `'span'`, `'p'`, `'a'` 等。
  - **属性 (data)**：一个对象，包含了要应用到该节点的属性，例如 `class`, `style`, `id`, `href` 等。
  - **子节点 (children)**：一个数组，包含了该节点的子节点，可以是字符串 (文本内容)，其他虚拟 DOM 节点，或数组 (包含多个子节点)。
    - 子节点内可以嵌套h函数的数组，形成树形结构

## patch函数：diff算法，最小量更新

- **key很重要**，key是这个节点的唯一标识，告诉了diff算法，在更改前后谁是同一节点
- 当定义key时，对原DOM结构进行增删改即可最小量更新
- **如何定义同一节点：选择器相同且key相同**
- 只有是同一个节点，才会进行精细化比较
- 只进行同层比较，不会跨层比较。跨层时不会进行diff，直接删除+新增

### 工作流程

![image-20240821171917731](C:\Users\12604\AppData\Roaming\Typora\typora-user-images\image-20240821171917731.png)

1. 判断oldNode老节点是否为虚拟节点，如果不是，则包装为虚拟节点
2. 判断oldNode和newNode是不是同一个节点
   1. 不是：暴力新增、删除
      1. 新增节点：selector
      2. 如果不存在子节点，直接返回dom
      3. 如果存在子节点，递归调用该方法 
   2. 是：精细化比较
      1. 是否指向内存中同一内存？
         1. 是：不变
         2. 不是：判断newVnode中是否存在text属性?
            1. 有：将**oldVnode.elm**中innerText改为text
            2. 没有（即newVnode中存在children）：判断oldVnode是否存在children
               1. 没有：意味着oldVnode有text
                  1. 清空text
                  2. 把newVnode的children添加到DOM
               2. 有：最复杂情况

当在diff中，新老节点都有子节点时，比较的步骤

1. 新增节点
   1. 新创建的节点插入到所有未处理的节点之前，而不是已处理节点之后

## diff算法优化策略

### 经典策略

- 四种命中查找：查找相同节点（selector和key相同）（前：首部，后：尾部）。如果命中一个就结束查找，指针移动（前指针下移，后指针上移），然后继续进行比较循环。
  1. 新前与旧前
  2. 新后与旧后
  3. 新后与旧前
     1. 如果找到：移动新后指向的节点到旧后的后面（也就是所有未处理的老节点之后）
  4. 新前与旧后
     1. 如果命中，移动新前指向的节点到旧前的前面（也就是所有未处理的老节点之前
- 直到找到不同的节点，则尝试新的命中查找
- 如果四种都没命中，则通过循环来寻找
  1. 在旧子节点中循环，寻找新子节点中新前指向的节点
  2. 找到后旧子节点标记为undefined，将新子节点插入到到旧前之前
  3. 新前继续下移
- 如果循环也没找到，则把新前指向节点插入到旧前之前
- 当新前<=新后或旧前<=旧后时，退出循环，旧前旧后之间的节点全部删除

## 整体流程

1. 通过h函数创建虚拟节点vnode
   1. 
2. 通过patch函数将虚拟DOM渲染到真实DOM中